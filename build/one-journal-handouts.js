!function(){"use strict";const e={MODULE_NAME:"one-journal-handouts",MODULE_TITLE:"One Journal Handouts"};e.PATH=`modules/${e.MODULE_NAME}/`;const t="gm-journal",n="players-journal",a="sharing-mode",i="duplicated-journal",s="open-page",o=()=>{const e={};if(game.journal){for(const[t,n]of game.journal.entries())e[t]=n.name.length>30?`${n.name.slice(0,30)}...`:n.name;return e}},l="open-page",r=async(t,n,a)=>{const i=Object.assign({},t.document.pages.find((e=>e.id===n)).toObject());foundry.utils.setProperty(i,`flags.${e.MODULE_NAME}`,n);const s=a.pages.map((e=>e.sort)),o=s.length?Math.max(...s):0;i.sort=o+1e4;const[l]=await a.createEmbeddedDocuments("JournalEntryPage",[i]);return l},g=async(e,t)=>{const n=e.document.pages.find((e=>e.id===t));n&&await e.document.deleteEmbeddedDocuments("JournalEntryPage",[n.id])},d=(t,n)=>{game.socket.emit(`module.${e.MODULE_NAME}`,{event:l,journalId:t.id,pageId:n}),game.settings.get(e.MODULE_NAME,s)&&t.sheet.render(!0,{pageId:n,sheetMode:JournalSheet.VIEW_MODES.SINGLE})};new class{constructor(){this.init()}init(){Hooks.once("init",(()=>{console.log(`${e.MODULE_TITLE} | Initializing module`),game.settings.register(e.MODULE_NAME,t,{name:`${e.MODULE_NAME}.settings.${t}-name`,hint:`${e.MODULE_NAME}.settings.${t}-hint`,scope:"world",config:!0,default:"all",type:new foundry.data.fields.StringField({blank:!1,choices:()=>foundry.utils.mergeObject({all:game.i18n.localize("all")},o())})}),game.settings.register(e.MODULE_NAME,n,{name:`${e.MODULE_NAME}.settings.${n}-name`,hint:`${e.MODULE_NAME}.settings.${n}-hint`,scope:"world",config:!0,default:"__!none!__",type:new foundry.data.fields.StringField({blank:!0,choices:o})}),game.settings.register(e.MODULE_NAME,a,{name:`${e.MODULE_NAME}.settings.${a}-name`,hint:`${e.MODULE_NAME}.settings.${a}-hint`,scope:"world",config:!0,default:"default",type:new foundry.data.fields.StringField({blank:!1,choices:{default:game.i18n.localize("Default"),duplicate:game.i18n.localize("Duplicate"),delete:game.i18n.localize("Delete")}})}),game.settings.register(e.MODULE_NAME,i,{name:`${e.MODULE_NAME}.settings.${i}-name`,hint:`${e.MODULE_NAME}.settings.${i}-hint`,scope:"world",config:!0,default:"__!none!__",type:new foundry.data.fields.StringField({blank:!0,choices:o})}),game.settings.register(e.MODULE_NAME,s,{name:`${e.MODULE_NAME}.settings.${s}-name`,hint:`${e.MODULE_NAME}.settings.${s}-hint`,scope:"world",config:!0,default:!0,type:Boolean}),game.socket.on(`module.${e.MODULE_NAME}`,(({event:e,journalId:t,pageId:n})=>{if(e!==l)return;const a=game.journal.get(t);a&&a.sheet.render(!0,{pageId:n,sheetMode:JournalSheet.VIEW_MODES.SINGLE})})),Hooks.on("getJournalSheetHeaderButtons",((s,o)=>{if(!game.users.current.isGM)return;const l=game.settings.get(e.MODULE_NAME,t),c=game.settings.get(e.MODULE_NAME,n),E=game.settings.get(e.MODULE_NAME,a),u=game.settings.get(e.MODULE_NAME,i);if(l&&c&&!o.find((t=>t.class===e.MODULE_NAME))&&s instanceof DocumentSheet){if("all"===l&&s.document.id===c)return;if("all"!==l&&s.document.id!==l)return;o.unshift({icon:"fas fa-square-share-nodes fa-fw",label:`${e.MODULE_NAME}.share-with-players`,class:e.MODULE_NAME,onclick:async()=>{const t=game.journal.get(c);if(!t)return ui.notifications.error(game.i18n.localize(`${e.MODULE_NAME}.no-players-journal`));const n=s.pagesInView[0]?.dataset?.pageId;if(!n)return;const a=t.pages.find((t=>t.flags?.[e.MODULE_NAME]===n));if(a)d(t,a.id);else{const a=await r(s,n,t);if("duplicate"===E){const t=game.journal.get(u);if(!t)return ui.notifications.error(game.i18n.localize(`${e.MODULE_NAME}.no-duplicated-journal`));await r(s,n,t),g(s,n)}"delete"===E&&g(s,n),d(t,a.id)}ui.notifications.info(game.i18n.localize(`${e.MODULE_NAME}.successful`))}})}}))}))}}}();