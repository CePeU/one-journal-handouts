!function(){"use strict";const e={MODULE_NAME:"one-journal-handouts",MODULE_TITLE:"One Journal Handouts"};e.PATH=`modules/${e.MODULE_NAME}/`;const n="gm-journal",t="players-journal",a="sharing-mode",s="duplicated-journal",i="open-page",o=()=>{const e={};if(game.journal){for(const[n,t]of game.journal.entries())e[n]=t.name.length>30?`${t.name.slice(0,30)}...`:t.name;return e}},l="open-page",r=async(n,t,a)=>{const s=Object.assign({},n.document.pages.find((e=>e.id===t)).toObject());foundry.utils.setProperty(s,`flags.${e.MODULE_NAME}`,{pageId:t});const i=a.pages.map((e=>e.sort)),o=i.length?Math.max(...i):0;s.sort=o+1e4;const[l]=await a.createEmbeddedDocuments("JournalEntryPage",[s]);return l},g=async(e,n)=>{const t=e.document.pages.find((e=>e.id===n));t&&await e.document.deleteEmbeddedDocuments("JournalEntryPage",[t.id])},d=(n,t)=>{game.socket.emit(`module.${e.MODULE_NAME}`,{event:l,journalId:n.id,pageId:t}),game.settings.get(e.MODULE_NAME,i)&&n.sheet.render(!0,{pageId:t,sheetMode:foundry.applications.sheets.journal.JournalEntrySheet.VIEW_MODES})};new class{constructor(){this.init()}init(){Hooks.once("init",(()=>{console.log(`${e.MODULE_TITLE} | Initializing module`),game.settings.register(e.MODULE_NAME,n,{name:`${e.MODULE_NAME}.settings.${n}-name`,hint:`${e.MODULE_NAME}.settings.${n}-hint`,scope:"world",config:!0,default:"all",type:new foundry.data.fields.StringField({blank:!1,choices:()=>foundry.utils.mergeObject({all:game.i18n.localize("all")},o())})}),game.settings.register(e.MODULE_NAME,t,{name:`${e.MODULE_NAME}.settings.${t}-name`,hint:`${e.MODULE_NAME}.settings.${t}-hint`,scope:"world",config:!0,default:"__!none!__",type:new foundry.data.fields.StringField({blank:!0,choices:o})}),game.settings.register(e.MODULE_NAME,a,{name:`${e.MODULE_NAME}.settings.${a}-name`,hint:`${e.MODULE_NAME}.settings.${a}-hint`,scope:"world",config:!0,default:"default",type:new foundry.data.fields.StringField({blank:!1,choices:{default:game.i18n.localize("Default"),duplicate:game.i18n.localize("Duplicate"),delete:game.i18n.localize("Delete")}})}),game.settings.register(e.MODULE_NAME,s,{name:`${e.MODULE_NAME}.settings.${s}-name`,hint:`${e.MODULE_NAME}.settings.${s}-hint`,scope:"world",config:!0,default:"__!none!__",type:new foundry.data.fields.StringField({blank:!0,choices:o})}),game.settings.register(e.MODULE_NAME,i,{name:`${e.MODULE_NAME}.settings.${i}-name`,hint:`${e.MODULE_NAME}.settings.${i}-hint`,scope:"world",config:!0,default:!0,type:Boolean}),game.socket.on(`module.${e.MODULE_NAME}`,(({event:e,journalId:n,pageId:t})=>{if(e!==l)return;const a=game.journal.get(n);a&&a.sheet.render(!0,{pageId:t,sheetMode:foundry.appv1.sheets.JournalSheet.VIEW_MODES.SINGLE})})),(()=>{const i=["getJournalSheetHeaderButtons","getHeaderControlsJournalEntrySheet"];for(const o of i)Hooks.on(o,((i,o)=>{if(!game.users.current.isGM)return;const l=game.settings.get(e.MODULE_NAME,n),c=game.settings.get(e.MODULE_NAME,t),u=game.settings.get(e.MODULE_NAME,a),E=game.settings.get(e.MODULE_NAME,s);if(l&&c&&!o.find((n=>n.class===e.MODULE_NAME))&&(i instanceof foundry.appv1.api.DocumentSheet||i instanceof foundry.applications.sheets.journal.JournalEntrySheet)){if("all"===l&&i.document.id===c)return;if("all"!==l&&i.document.id!==l)return;const n=async()=>{const n=game.journal.get(c);if(!n)return ui.notifications.error(game.i18n.localize(`${e.MODULE_NAME}.no-players-journal`));const t=i.pagesInView[0]?.dataset?.pageId;if(!t)return;const a=n.pages.find((n=>n.flags?.[e.MODULE_NAME]===t||n.flags?.[e.MODULE_NAME]?.pageId===t));if(a)d(n,a.id);else{const a=await r(i,t,n);if("duplicate"===u){const n=game.journal.get(E);if(!n)return ui.notifications.error(game.i18n.localize(`${e.MODULE_NAME}.no-duplicated-journal`));await r(i,t,n),g(i,t)}"delete"===u&&g(i,t),d(n,a.id)}ui.notifications.info(game.i18n.localize(`${e.MODULE_NAME}.successful`))};o.unshift({icon:"fas fa-square-share-nodes fa-fw",label:`${e.MODULE_NAME}.share-with-players`,class:e.MODULE_NAME,onClick:n,onclick:n})}}))})()}))}}}();